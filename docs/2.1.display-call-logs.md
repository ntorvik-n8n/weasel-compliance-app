# Story 2.1: Display a List of Uploaded Call Logs

## Story Overview

**Story ID:** 2.1
**Epic:** Epic 2 - Enhanced Call Log Management
**Priority:** P0 (Critical)
**Status:** Done
**Story Points:** 5
**Sprint:** TBD

## User Story

**As a** compliance officer,
**I want** to see a list of all uploaded call log files,
**so that** I can quickly view what has been processed and is available for review.

## Background

With the file upload system in place, users need a way to view the files they've uploaded. This story creates the foundational UI for browsing call logs. It will serve as the main interface for selecting files for detailed analysis in later stories.

## Acceptance Criteria

### Functional Requirements

1.  **List Display**
    - [x] A new page or section displays a list/table of uploaded files.
    - [x] The list is fetched from a dedicated server-side API endpoint (`/api/call-logs`).
    - [x] Each item in the list shows at least:
        - Filename
        - File Size (in a human-readable format, e.g., KB, MB)
        - Upload Date/Time

2.  **Sorting**
    - [x] By default, the list is sorted by upload date in descending order (newest first).
    - [x] The API supports sorting by other columns (filename, size).

3.  **Pagination**
    - [x] The list is paginated, showing a configurable number of files per page (e.g., 25).
    - [x] Pagination controls (e.g., "Next," "Previous," page numbers) are present and functional.
    - [x] The UI displays the current page and total number of pages or files.

4.  **API Endpoint**
    - [x] A `GET /api/call-logs` endpoint is created.
    - [x] The endpoint lists blobs from the Azure Storage container.
    - [x] The endpoint supports query parameters for pagination (`page`, `limit`) and sorting (`sortBy`, `order`).
    - [x] The endpoint returns a structured JSON response with the list of files and pagination metadata.

### Non-Functional Requirements

5.  **Performance**
    - [x] The list page loads within 2 seconds for up to 1,000 files.
    - [x] API response time is under 500ms for a single page of results.

6.  **Usability**
    - [x] A loading state is shown while files are being fetched.
    - [x] An error state is shown if the API call fails.
    - [x] An empty state is displayed if no files have been uploaded yet.

## Technical Design

### 1. API Route (`/api/call-logs/route.ts`)

-   **Method:** `GET`
-   **Logic:**
    -   Instantiate the `BlobStorageService` from `lib/azure/blobStorageClient.ts`. **(Refactored to `getBlobStorageService`)**
    -   Parse query parameters: `continuationToken`, `limit` (default 10), `sortBy` (default `uploadedAt`), `order` (default `desc`).
    -   Call a new method on the service, `listBlobsWithMetadata`, which will list blobs from the `call-logs-raw` container.
    -   The Azure SDK's `listBlobsFlat().byPage()` method with continuation tokens is used for scalable pagination.
    -   The API will map the blob properties to a `CallLogMetadata` object.
    -   The response will be structured as:
        ```json
        {
          "data": [ ...CallLogMetadata ],
          "pagination": {
            "nextContinuationToken": "..."
          }
        }
        ```

### 2. Data Type (`types/callLog.ts`)

```typescript
export interface CallLogMetadata {
  id: string; // A unique identifier, could be the blob name
  filename: string;
  size: number; // in bytes
  uploadedAt: string; // ISO 8601 string
  contentType: string;
  url: string; // URL to the blob
}

export interface PaginatedCallLogs {
  data: CallLogMetadata[];
  pagination: {
    nextContinuationToken: string | null;
  };
}
```

### 3. Frontend Component (`components/call-logs/CallLogList.tsx`)

-   **State Management:**
    -   `useState` to store the list of files, loading state, error state, and current page.
-   **Data Fetching:**
    -   `useEffect` hook to fetch data from `/api/call-logs` when the component mounts or the page number changes.
    -   Use the `fetch` API to make the request.
-   **Rendering:**
    -   Use a `<table>` to display the data.
    -   Render a loading spinner, error message, or empty state based on the current state.
    -   Render pagination controls that update the `page` state variable.

## Dependencies

### Story Dependencies
-   **Story 1.5 (Azure Blob Storage):** Required for the API to list files. The `BlobStorageService` is a prerequisite.

## Testing Strategy

### Unit Tests
-   [ ] Test the API route's query parameter parsing.
-   [ ] Test the `CallLogList` component's rendering in loading, error, and success states.

### Integration Tests
-   [ ] Test that the `CallLogList` component correctly fetches and displays data from the mock API.
-   [ ] Test pagination controls to ensure they fetch the correct page of data.

### End-to-End Tests
-   [ ] Navigate to the call logs page and verify the list of uploaded files is displayed correctly.
-   [ ] Test pagination by clicking "Next" and "Previous" and verifying the list updates.

## Definition of Done

-   [ ] All acceptance criteria are met.
-   [ ] The `/api/call-logs` endpoint is created and returns paginated file metadata.
-   [ ] The `CallLogList` component fetches and displays the list of files.
-   [ ] Pagination is functional.
-   [ ] Loading, error, and empty states are handled correctly.
-   [ ] Unit and integration tests are written and passing.
-   [ ] Code is reviewed and approved.
-   [ ] Deployed to staging environment.

## Success Metrics

-   **Technical:** API response time < 500ms.
-   **User Experience:** Users can view the list of their uploaded files.

---

*Story created: 2025-10-11*
*Last updated: 2025-10-11*
*Product Owner: Sarah*