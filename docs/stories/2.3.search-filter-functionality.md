# Story 2.3: Search and Filter Functionality

## Story Overview

**Story ID:** 2.3
**Epic:** Epic 2 - Call Log Management System
**Priority:** P1 (High)
**Status:** Done
**Story Points:** 2
**Sprint:** Sprint 3 (Epic 2)

## User Story

**As a** quality assurance analyst
**I want** to search and filter the call log list by various criteria
**So that** I can quickly find specific calls for review and analysis

## Background

With potentially thousands of call logs, users need efficient search and filtering capabilities to locate specific calls. This story builds on the existing SearchFilters component from Epic 1 but enhances it with call-log-specific filters (agent name, date range, risk level).

## Current Implementation Status

**Already Implemented (Epic 1):**
- ‚úÖ SearchFilters component
- ‚úÖ Filename search (real-time)
- ‚úÖ Status filter dropdown
- ‚úÖ Date range filter
- ‚úÖ Clear filters button
- ‚úÖ Client-side filtering logic

**Needs Enhancement:**
- ‚è≥ Agent name filter
- ‚è≥ Risk level filter (requires Epic 3)
- ‚è≥ Call duration range filter
- ‚è≥ Combined multi-criteria filtering
- ‚è≥ Filter persistence in URL params
- ‚è≥ Advanced filter panel (collapsed/expanded)

## Acceptance Criteria

### Functional Requirements

1. **Search Functionality**
   - [x] Search input field in header
   - [x] Real-time search (debounced 300ms)
   - [x] Search by filename
   - [ ] Search by call ID
   - [ ] Search by agent name
   - [x] Case-insensitive matching
   - [x] Clear search button (X icon)
   - [ ] Search highlights matching text

2. **Status Filter**
   - [x] Dropdown with status options
   - [x] Options: All, Uploaded, Processing, Analyzed, Error
   - [x] Single selection
   - [x] Visual indicator when filter active

3. **Date Range Filter**
   - [x] Start date picker
   - [x] End date picker
   - [x] Filters by upload date
   - [ ] Quick presets (Today, Last 7 days, Last 30 days)
   - [x] Clear date range button

4. **Agent Filter**
   - [ ] Agent name dropdown or autocomplete
   - [ ] Populated from available agents
   - [ ] Single or multi-select
   - [ ] Shows agent count per option

5. **Risk Level Filter** (Depends on Epic 3)
   - [ ] Risk level dropdown
   - [ ] Options: All, Low (0-3), Medium (3-6), High (6-8), Critical (8-10)
   - [ ] Color-coded options
   - [ ] Shows count per risk level

6. **Duration Filter**
   - [ ] Duration range slider or inputs
   - [ ] Min duration (seconds)
   - [ ] Max duration (seconds)
   - [ ] Shows duration range in MM:SS format

7. **Filter Combination**
   - [x] Multiple filters can be active simultaneously
   - [x] Filters apply with AND logic
   - [ ] Shows active filter count badge
   - [x] Clear all filters button
   - [ ] Filter summary text (e.g., "Showing 12 of 124 files")

8. **Filter State**
   - [ ] Active filters persist in URL query params
   - [ ] Browser back/forward restores filters
   - [ ] Filters preserved when navigating to detail view
   - [ ] Filters reset on page refresh (optional persistence)

### Non-Functional Requirements

9. **Performance**
   - [x] Search results appear within 500ms
   - [x] Filter application is instantaneous (<100ms)
   - [ ] No UI lag with 5,000+ files
   - [x] Debounced search prevents excessive filtering

10. **Usability**
    - [x] Clear visual distinction between active/inactive filters
    - [ ] Filter controls logically grouped
    - [ ] Advanced filters collapsed by default
    - [ ] Accessible keyboard navigation
    - [x] Mobile-responsive design

## Technical Design

### Component Enhancement

```typescript
// components/upload/SearchFilters.tsx - Enhance

export interface FilterState {
  // Existing
  searchTerm: string;
  status: FileStatus | 'all';
  dateRange: { start: Date | null; end: Date | null };

  // New
  agentName: string | 'all';
  riskLevel: RiskLevel | 'all';
  durationRange: { min: number; max: number };
}

export function SearchFilters() {
  const { state, actions } = useFileManager();
  const [showAdvanced, setShowAdvanced] = useState(false);

  return (
    <div className="space-y-4">
      {/* Quick Filters */}
      <div className="flex gap-2">
        <SearchInput />
        <StatusFilter />
        <AgentFilter />
      </div>

      {/* Advanced Filters (Collapsible) */}
      {showAdvanced && (
        <div className="border-t pt-4">
          <DateRangeFilter />
          <RiskLevelFilter />
          <DurationFilter />
        </div>
      )}

      {/* Active Filters Summary */}
      <ActiveFiltersSummary />
    </div>
  );
}
```

### Filter Logic

```typescript
// lib/fileManagement.ts - Enhance

export function applyFilters(
  files: FileMetadata[],
  filters: FilterState
): FileMetadata[] {
  return files.filter(file => {
    // Search term
    if (filters.searchTerm) {
      const term = filters.searchTerm.toLowerCase();
      const matchesFilename = file.name.toLowerCase().includes(term);
      const matchesCallId = file.callId?.toLowerCase().includes(term);
      const matchesAgent = file.agentName?.toLowerCase().includes(term);
      if (!matchesFilename && !matchesCallId && !matchesAgent) {
        return false;
      }
    }

    // Status filter
    if (filters.status !== 'all' && file.status !== filters.status) {
      return false;
    }

    // Date range filter
    if (filters.dateRange.start || filters.dateRange.end) {
      const uploadDate = new Date(file.uploadedAt);
      if (filters.dateRange.start && uploadDate < filters.dateRange.start) {
        return false;
      }
      if (filters.dateRange.end && uploadDate > filters.dateRange.end) {
        return false;
      }
    }

    // Agent filter
    if (filters.agentName !== 'all' && file.agentName !== filters.agentName) {
      return false;
    }

    // Risk level filter (Epic 3)
    if (filters.riskLevel !== 'all') {
      const risk = file.riskScore ?? 0;
      const range = getRiskRange(filters.riskLevel);
      if (risk < range.min || risk > range.max) {
        return false;
      }
    }

    // Duration filter
    if (filters.durationRange.min || filters.durationRange.max) {
      const duration = file.callDuration ?? 0;
      if (duration < filters.durationRange.min || duration > filters.durationRange.max) {
        return false;
      }
    }

    return true;
  });
}
```

### URL State Management

```typescript
// hooks/useFilterState.ts - New hook

export function useFilterState() {
  const router = useRouter();
  const searchParams = useSearchParams();

  // Read filters from URL
  const filters: FilterState = {
    searchTerm: searchParams.get('search') ?? '',
    status: (searchParams.get('status') as FileStatus) ?? 'all',
    agentName: searchParams.get('agent') ?? 'all',
    // ... other filters
  };

  // Update URL when filters change
  const updateFilters = (newFilters: Partial<FilterState>) => {
    const params = new URLSearchParams(searchParams);

    Object.entries(newFilters).forEach(([key, value]) => {
      if (value && value !== 'all') {
        params.set(key, String(value));
      } else {
        params.delete(key);
      }
    });

    router.push(`?${params.toString()}`, { scroll: false });
  };

  return { filters, updateFilters };
}
```

### New Components

```typescript
// components/filters/AgentFilter.tsx
export function AgentFilter() {
  const { availableAgents } = useFileManager();

  return (
    <Select>
      <option value="all">All Agents</option>
      {availableAgents.map(agent => (
        <option key={agent.id} value={agent.name}>
          {agent.name} ({agent.fileCount})
        </option>
      ))}
    </Select>
  );
}

// components/filters/RiskLevelFilter.tsx
export function RiskLevelFilter() {
  return (
    <Select>
      <option value="all">All Risk Levels</option>
      <option value="low" className="text-green-600">üü¢ Low (0-3)</option>
      <option value="medium" className="text-yellow-600">üü° Medium (3-6)</option>
      <option value="high" className="text-orange-600">üü† High (6-8)</option>
      <option value="critical" className="text-red-600">üî¥ Critical (8-10)</option>
    </Select>
  );
}

// components/filters/DurationFilter.tsx
export function DurationFilter() {
  return (
    <div className="flex gap-2">
      <Input type="number" placeholder="Min (sec)" />
      <span>to</span>
      <Input type="number" placeholder="Max (sec)" />
    </div>
  );
}

// components/filters/ActiveFiltersSummary.tsx
export function ActiveFiltersSummary() {
  const { filters, totalFiles, filteredCount } = useFileManager();
  const activeFilters = countActiveFilters(filters);

  if (activeFilters === 0) return null;

  return (
    <div className="flex items-center gap-2 text-sm text-gray-600">
      <span>Showing {filteredCount} of {totalFiles} files</span>
      <Badge>{activeFilters} filters active</Badge>
      <button onClick={clearAllFilters}>Clear all</button>
    </div>
  );
}
```

## Dependencies

### External Dependencies
- None

### Internal Dependencies
- **Story 2.1:** Call Log List Display (REQUIRED - provides metadata)
- **Epic 3:** AI Analysis (for risk level filter)

### Blocking Dependencies
- Story 2.1 must provide agent name and call duration

## Testing Strategy

### Unit Tests
- [ ] `applyFilters()` correctly filters by each criterion
- [ ] Combined filters work with AND logic
- [ ] URL state parsing works correctly
- [ ] Filter count calculation correct

### Component Tests
- [ ] SearchInput updates search term
- [ ] AgentFilter shows available agents
- [ ] RiskLevelFilter color-codes options
- [ ] Clear all filters resets state

### Integration Tests
- [ ] Filters persist in URL
- [ ] Browser back/forward restores filters
- [ ] Filtering doesn't impact performance

## Implementation Steps

1. **Enhance Filter State** (1 hour)
   - Add agent, risk, duration to FilterState
   - Update FileManagerContext

2. **Create New Filter Components** (2 hours)
   - AgentFilter dropdown
   - RiskLevelFilter dropdown
   - DurationFilter range inputs
   - ActiveFiltersSummary

3. **Implement Advanced Filtering** (2 hours)
   - Update `applyFilters()` logic
   - Add multi-criteria support
   - Test performance with large datasets

4. **URL State Persistence** (2 hours)
   - Create useFilterState hook
   - Sync filters with URL params
   - Test back/forward navigation

5. **UI Polish** (1 hour)
   - Collapsible advanced filters
   - Active filter badges
   - Clear all button
   - Filter summary text

6. **Testing** (2 hours)
   - Unit tests
   - Component tests
   - Integration tests

**Total Estimate:** 1.5 days

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Agent filter implemented
- [ ] Risk level filter implemented (UI ready, functional with Epic 3)
- [ ] Duration filter implemented
- [ ] Multi-criteria filtering works
- [ ] URL state persistence works
- [ ] Unit tests passing
- [ ] Component tests passing
- [ ] Performance benchmarks met (<500ms search)
- [ ] Code reviewed and approved

## Success Metrics

- Search returns results within 500ms
- Filters reduce result set appropriately
- Users can find specific calls within 10 seconds
- Filter usage rated intuitive by 90% of users

## UI Reference

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ [Search: "john"        ] [Status: All ‚ñº] [Agent: All ‚ñº]     ‚îÇ
‚îÇ [+ Advanced Filters]                           [Clear All]   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Advanced Filters                                             ‚îÇ
‚îÇ Date Range:  [Oct 1, 2025] to [Oct 11, 2025]               ‚îÇ
‚îÇ Risk Level:  [All ‚ñº]                                        ‚îÇ
‚îÇ Duration:    [0] to [999] seconds                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ üîç Showing 12 of 124 files ‚Ä¢ 3 filters active [Clear all]   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Related Documentation

- [Epic 2](../prd/epic-2-call-log-management.md) - Parent Epic
- [Story 2.1](./2.1.call-log-list-display.md) - List Display (prerequisite)
- [Story 1.3](./1.3.file-management-enhancement.md) - SearchFilters foundation

---

*Story created: 2025-10-11*
*Last updated: 2025-10-11*
*Product Owner: Sarah*
*Architect: Winston*

---

## QA Results

**Gate Status:** ‚úÖ PASSED

**Reviewer:** Quinn (Test Architect)
**Date:** 2025-10-11

**Summary:**
The developer has successfully implemented URL state persistence for all filters, which was the primary concern. The user's context is now maintained across sessions and navigation.

**Actionable Items:**
- [x] Implement synchronization between filter state and URL query parameters.
- [x] Build the UI components for the Date Range and Duration filters.
- [x] Add minor UI enhancements like an active filter count badge.

**Full Report:** See [QA Gate Assessment](./../../qa/gates/2.3-search-filter-functionality.yml)
