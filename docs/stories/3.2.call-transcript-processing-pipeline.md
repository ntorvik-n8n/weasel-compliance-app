# Story 3.2: Call Transcript Processing Pipeline

## Story Overview

**Story ID:** 3.2
**Epic:** Epic 3 - AI Compliance Analysis Engine
**Priority:** P0 (Critical)
**Status:** âœ… Complete
**Story Points:** 3
**Sprint:** Sprint 4 (Epic 3)

## User Story
**As a** system
**I want** to automatically trigger an AI analysis when a new call log is uploaded
**So that** every file is processed for compliance without manual intervention.

## Technical Design
1.  **Create a New API Route for Processing:**
    -   Create a new API route: `app/api/process/[filename]/route.ts`.
    -   This route will be responsible for orchestrating the analysis of a single file.
2.  **Orchestration Logic:**
    -   The API route's `POST` handler will receive a filename.
    -   It will first update the file's status metadata in Azure Blob Storage to `'processing'`.
    -   It will then fetch the file's content from blob storage.
    -   Next, it will call the `getComplianceAnalysis` function from `lib/anthropic/client.ts` (created in Story 3.1) with the transcript.
    -   This should be an asynchronous, "fire-and-forget" operation from the client's perspective. The client that calls this endpoint should not wait for the analysis to complete.
3.  **Update Upload Logic:**
    -   Modify the file upload API route (`app/api/upload/route.ts`) to call this new processing endpoint after a successful upload.
    -   The call should be made asynchronously without blocking the response to the user.

## Acceptance Criteria
- [x] A new API route `app/api/process/[filename]/route.ts` is created.
- [x] After a file is successfully uploaded, the new API route is called.
- [x] The processing route correctly updates the file's status to `'processing'`.
- [x] The route fetches the transcript and successfully calls the Anthropic client service.
- [x] The user's upload experience is not blocked or delayed by the start of the analysis process.

---
*Architect: Winston*

---
## Dev Agent Record

**Completed by:** James (Full Stack Developer)
**Date:** 2025-10-11

**Summary of Work:**
- Created a new API endpoint at `/api/process/[filename]` to handle the orchestration of the AI analysis.
- The endpoint is designed to be asynchronous, immediately returning a success response while kicking off the analysis in the background.
- The background process updates the file's status to `'processing'`, fetches the content, and calls the Anthropic analysis service created in the previous story.
- Modified the original `/api/upload` endpoint to make a non-blocking call to the new processing endpoint, successfully triggering the pipeline after each upload.

**Next Steps:**
- The next story will handle the results of the AI analysis, storing them and updating the file's final status.
