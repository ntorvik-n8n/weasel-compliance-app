# Story 3.3: Analysis Result Storage and Status Update

## Story Overview

**Story ID:** 3.3
**Epic:** Epic 3 - AI Compliance Analysis Engine
**Priority:** P0 (Critical)
**Status:** âœ… Complete
**Story Points:** 3
**Sprint:** Sprint 4 (Epic 3)

## User Story
**As a** system
**I want** to securely store the AI analysis results and update the file's status
**So that** the results are permanently associated with the call log and the UI reflects the completed status.

## Technical Design
1.  **Create a New Blob Storage Container:**
    -   The `BlobStorageService` in `lib/azure/blobStorageClient.ts` needs to be aware of a new container, `analysis-results`.
2.  **Store Analysis JSON:**
    -   After the `getComplianceAnalysis` function returns a valid result in the `process` API route, the system will upload the full JSON result to the `analysis-results` container.
    -   The blob name for the result should directly correlate with the original file's name (e.g., `call-log-123.json` -> `call-log-123.json`).
3.  **Update Final Status:**
    -   Once the result is stored, update the original file's metadata in the `uploads` container.
    -   Set the `status` to `'analyzed'`.
    -   Add a new metadata field, `analysisResultUrl`, pointing to the location of the result blob.
4.  **Error Handling:**
    -   If the AI analysis fails (e.g., API error, invalid response), the `process` route must catch the error.
    -   It should update the original file's metadata `status` to `'error'`.
    -   It should also store an `errorMessage` in the metadata.

## Acceptance Criteria
- [x] The `BlobStorageService` is configured to use an `analysis-results` container.
- [x] A successful analysis result is saved as a new JSON blob in the correct container.
- [x] After a successful analysis, the original file's metadata is updated with `status: 'analyzed'`.
- [x] A pointer to the analysis result is stored in the original file's metadata.
- [x] If analysis fails, the original file's metadata is updated with `status: 'error'` and an error message.

---
*Architect: Winston*

---
## Dev Agent Record

**Completed by:** James (Full Stack Developer)
**Date:** 2025-10-11

**Summary of Work:**
- Enhanced the `BlobStorageService` to support a new `analysis-results` container.
- Implemented the `uploadAnalysisResult` method to save the JSON output from the AI.
- Updated the `processAnalysis` function to perform the full end-to-end process:
    1.  Sets status to `processing`.
    2.  Calls the AI service.
    3.  On success, stores the result in the new container and updates the original file's status to `analyzed`, also adding the `riskScore` and a URL to the result in the metadata.
    4.  On failure, updates the original file's status to `error` and records the error message.

**Next Steps:**
- The next story will focus on displaying the `riskScore` in the UI, now that it's being saved to the file's metadata.
