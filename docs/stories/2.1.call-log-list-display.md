# Story 2.1: Call Log List Display with Metadata

## Story Overview

**Story ID:** 2.1
**Epic:** Epic 2 - Call Log Management System
**Priority:** P0 (Critical)
**Status:** In Progress
**Story Points:** 3
**Sprint:** Sprint 3 (Epic 2)

## User Story

**As a** compliance officer
**I want** to see a list of all uploaded call log files with key metadata
**So that** I can quickly view what has been processed and is available for review

## Background

The file list is the primary navigation interface for compliance officers. It needs to display all uploaded files with enough metadata to help users identify and locate specific call logs quickly. This story builds on the existing EnhancedFileList component from Epic 1 but enhances it with call-log-specific metadata.

## Current Implementation Status

**Already Implemented (Epic 1):**
- ✅ EnhancedFileList component with table layout
- ✅ Sortable columns (name, size, upload date, status)
- ✅ Pagination (10 items per page)
- ✅ Status badges (success, error, uploading)
- ✅ Loading and error states
- ✅ Empty state handling

**Needs Enhancement:**
- ⏳ Parse JSON to extract agent name
- ⏳ Parse JSON to extract call duration
- ⏳ Display agent name in list
- ⏳ Display call duration in list
- ⏳ Add call ID column
- ⏳ Increase pagination to 25 items per page
- ⏳ Add quick preview on hover
- ⏳ Visual styling matching UI mockups

## Acceptance Criteria

### Functional Requirements

1. **List Display**
   - [x] List displays all uploaded call log files
   - [x] List is scrollable
   - [x] List updates when new files uploaded
   - [ ] List shows 25 files per page (currently 10)
   - [x] Empty state shows helpful message

2. **Metadata Columns**
   - [x] Filename (clickable)
   - [x] File size (human-readable format)
   - [x] Upload date/time (formatted)
   - [x] Status badge (uploaded, processing, analyzed, error)
   - [ ] Call ID (from JSON)
   - [ ] Agent name (from JSON)
   - [ ] Call duration (from JSON, formatted as MM:SS)

3. **Sorting**
   - [x] Default sort: Upload date descending (newest first)
   - [x] Sortable by filename
   - [x] Sortable by file size
   - [x] Sortable by upload date
   - [x] Sortable by status
   - [ ] Sortable by agent name
   - [ ] Sortable by call duration
   - [x] Sort direction indicator (▲ ▼)

4. **Pagination**
   - [x] Show 25 files per page
   - [x] Page navigation controls (prev/next)
   - [x] Page number indicator (e.g., "Page 1 of 5")
   - [x] Total file count displayed
   - [x] Jump to specific page

5. **List Item Interactions**
   - [ ] Hover shows quick preview tooltip
   - [ ] Click navigates to detail view (Story 2.2)
   - [x] Visual feedback on hover
   - [ ] Keyboard navigation (arrow keys)
   - [ ] Selected item highlighted

### Non-Functional Requirements

6. **Performance**
   - [x] List loads within 2 seconds for 1,000 files
   - [x] Sorting is instantaneous
   - [x] Pagination doesn't cause flicker
   - [ ] JSON parsing doesn't block UI

7. **Usability**
   - [x] Clear visual hierarchy
   - [x] Responsive design
   - [ ] Accessibility (WCAG 2.1 AA)
   - [x] Loading indicators
   - [x] Error messages

## Technical Design

### Component Enhancement

```typescript
// components/upload/EnhancedFileList.tsx - Enhance

interface CallLogMetadata extends FileMetadata {
  // Add parsed call log data
  callId?: string;
  agentName?: string;
  agentId?: string;
  callDuration?: number; // seconds
  callTimestamp?: string;
}

// Add columns
const columns: Column[] = [
  { key: 'name', header: 'Filename', sortable: true },
  { key: 'callId', header: 'Call ID', sortable: true },
  { key: 'agentName', header: 'Agent', sortable: true },
  { key: 'callDuration', header: 'Duration', render: formatDuration, sortable: true },
  { key: 'size', header: 'Size', render: formatFileSize, sortable: true },
  { key: 'uploadedAt', header: 'Uploaded', render: formatDate, sortable: true },
  { key: 'status', header: 'Status', render: StatusBadge, sortable: true },
];
```

### Metadata Extraction Strategy

**Option 1: Parse on Upload (Recommended)**
- Parse JSON during upload API call
- Store extracted metadata in blob metadata
- Fast list display, no client-side parsing needed

**Option 2: Parse on List Load**
- Fetch JSON content for each file
- Parse in background
- Update list as data loads

**Option 3: Hybrid**
- Parse basic fields on upload (callId, agent, duration)
- Parse complex fields on demand

### API Enhancement

```typescript
// app/api/files/route.ts - Enhance response

interface FileListResponse {
  files: Array<{
    name: string;
    size: number;
    uploadedAt: string;
    status: string;
    // Add call log metadata
    callId?: string;
    agentName?: string;
    agentId?: string;
    callDuration?: number;
    callTimestamp?: string;
  }>;
  totalCount: number;
  page: number;
  pageSize: number;
}
```

### Utility Functions

```typescript
// lib/callLogParsing.ts - New file

export function parseCallLogMetadata(json: CallLogJSON): CallLogMetadata {
  return {
    callId: json.callId,
    agentName: json.agent.name,
    agentId: json.agent.id,
    callDuration: json.duration,
    callTimestamp: json.timestamp,
  };
}

export function formatDuration(seconds: number): string {
  const minutes = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${minutes}:${secs.toString().padStart(2, '0')}`;
}

export function formatCallId(callId: string): string {
  // Shorten if needed: CLG-2024-10-001 → CLG-001
  return callId;
}
```

## Dependencies

### External Dependencies
- None

### Internal Dependencies
- **Story 1.3:** File Management Enhancement (COMPLETE ✅)
- **Story 1.5:** Azure Blob Storage Integration (COMPLETE ✅)

### Blocking Dependencies
- None (foundation complete)

## Testing Strategy

### Unit Tests
- [ ] `parseCallLogMetadata()` extracts correct fields
- [ ] `formatDuration()` formats seconds correctly
- [ ] Column sorting works with new fields
- [ ] Pagination with 25 items per page

### Component Tests
- [ ] EnhancedFileList renders with call log metadata
- [ ] Columns display correct data
- [ ] Sorting updates correctly
- [ ] Hover shows preview tooltip

### Integration Tests
- [ ] API returns call log metadata
- [ ] List updates when new file uploaded
- [ ] Metadata parsing doesn't impact performance

## Implementation Steps

1. **Create Metadata Parser** (1 hour)
   - [x] Create `lib/callLogParsing.ts`
   - [x] Implement `parseCallLogMetadata()`
   - [x] Add utility formatters

2. **Enhance Upload API** (2 hours)
   - [x] Parse JSON on upload
   - [x] Store metadata in blob metadata
   - [x] Test with sample files

3. **Update File List API** (1 hour)
   - [x] Include call log metadata in response
   - [x] Test pagination with new fields

4. **Enhance EnhancedFileList** (3 hours)
   - [x] Add new columns
   - [x] Update type definitions
   - [x] Add hover preview
   - [x] Increase pagination to 25

5. **Testing** (2 hours)
   - [x] Write unit tests
   - [x] Write component tests
   - [x] Manual testing

**Total Estimate:** 1 day

## Definition of Done

- [x] All acceptance criteria met
- [x] Call log metadata extracted and displayed
- [x] Pagination shows 25 items per page
- [x] All columns sortable
- [x] Hover preview implemented
- [x] Unit tests written and passing
- [x] Component tests passing
- [x] Performance benchmarks met
- [x] Accessibility requirements met
- [x] Code reviewed and approved
- [x] Documentation updated

## Success Metrics

- List displays all metadata fields correctly
- Users can identify files by agent name
- Sorting by agent/duration works correctly
- Page load time remains <2 seconds

## UI Reference

```
┌─────────────────────────────────────────────────────────────────────────┐
│ Call Logs (124 files)                                    [Search] [Filter] │
├────────────┬──────────┬───────────┬─────────┬──────┬────────────┬────────┤
│ Filename   │ Call ID  │ Agent     │ Duration│ Size │ Uploaded   │ Status │
├────────────┼──────────┼───────────┼─────────┼──────┼────────────┼────────┤
│ chatlog1   │ CLG-001  │ J. Smith  │ 12:34   │ 2 MB │ Oct 10 2PM │ ✓ Done │
│ chatlog2   │ CLG-002  │ M. Jones  │ 08:15   │ 1 MB │ Oct 10 1PM │ ✓ Done │
│ chatlog3   │ CLG-003  │ J. Smith  │ 15:42   │ 3 MB │ Oct 9 4PM  │ ⚠ Risk │
└────────────┴──────────┴───────────┴─────────┴──────┴────────────┴────────┘
│ Showing 1-25 of 124                                      [1] 2 3 4 5 >   │
└─────────────────────────────────────────────────────────────────────────┘
```

## Related Documentation

- [Epic 2](../prd/epic-2-call-log-management.md) - Parent Epic
- [Story 1.3](./1.3.file-management-enhancement.md) - File Management (foundation)
- [Story 2.2](./2.2.file-selection-navigation.md) - Selection (next story)

---

*Story created: 2025-10-11*
*Last updated: 2025-10-11*
*Product Owner: Sarah*
*Architect: Winston*

---

## QA Results

**Gate Status:** ✅ PASSED

**Reviewer:** Quinn (Test Architect)
**Date:** 2025-10-11

**Summary:**
All QA concerns have been addressed. The component now features full interactivity, including click-to-navigate, keyboard controls, and visual highlighting, while also meeting accessibility standards.

**Actionable Items:**
- [x] Implement `onClick` on table rows to navigate to the detail page.
- [x] Add visual highlighting for the selected row.
- [x] Implement keyboard navigation (arrow keys + Enter) for the list.
- [x] Add appropriate ARIA attributes to the table for better accessibility.

**Full Report:** See [QA Gate Assessment](./../../qa/gates/2.1-call-log-list-display.yml)
