# Story 1.6: Upload Progress & Error Handling

## Story Overview

**Story ID:** 1.6
**Epic:** Epic 1 - File Upload & Storage Infrastructure
**Priority:** P0 (Critical)
**Status:** Done
**Story Points:** 5
**Sprint:** TBD

## User Story

**As a** compliance officer
**I want** to see real-time upload progress and receive clear error messages when uploads fail
**So that** I know the status of my file uploads, can take corrective action when problems occur, and have confidence in the upload process

## Background

Users need visibility into upload status to understand what's happening, especially for larger files or multiple uploads. When errors occur, clear messaging helps users resolve issues quickly without contacting support. This story implements comprehensive progress tracking and error handling throughout the upload lifecycle.

## Acceptance Criteria

### Functional Requirements

1. **Upload Progress Indicators**
   - [ ] Progress bar shows percentage complete (0-100%)
   - [ ] Progress updates at least every 500ms during upload
   - [ ] File size indicator shows uploaded vs. total (e.g., "1.2 MB / 5.0 MB")
   - [ ] Estimated time remaining displayed (e.g., "30 seconds remaining")
   - [ ] Upload speed shown (e.g., "2.5 MB/s")
   - [ ] Visual indicator distinguishes between:
     - Preparing (validating file)
     - Uploading (sending to Azure)
     - Processing (server-side operations)
     - Complete (successfully uploaded)

2. **Progress Display Locations**
   - [ ] Individual file progress in upload zone during active upload
   - [ ] Sidebar shows progress for all active uploads
   - [ ] Mini progress indicator in recently uploaded section
   - [ ] Progress persists if user navigates away and returns

3. **Upload States**
   - [ ] **Queued** - File waiting to upload (when concurrent limit reached)
   - [ ] **Validating** - Checking file format and size
   - [ ] **Checking Collision** - Verifying filename availability
   - [ ] **Uploading** - Actively transferring to Azure
   - [ ] **Processing** - Server-side operations (metadata, storage)
   - [ ] **Complete** - Successfully uploaded and stored
   - [ ] **Failed** - Upload encountered error
   - [ ] **Cancelled** - User cancelled upload

4. **Error Handling - File Validation Errors**
   - [ ] **Invalid file type:** "Only JSON files are supported. Please select a .json file."
   - [ ] **File too large:** "File exceeds 10MB limit. Current size: {size}MB. Please reduce file size."
   - [ ] **Invalid JSON structure:** "File is not valid JSON. Error at line {line}: {error}"
   - [ ] **Missing required fields:** "Call log missing required fields: {fields}"
   - [ ] **Empty file:** "File is empty. Please select a valid call log file."

5. **Error Handling - Network Errors**
   - [ ] **Network disconnected:** "Network connection lost. Retrying upload..."
   - [ ] **Timeout:** "Upload timed out. Please try again or check your connection."
   - [ ] **Azure service unavailable:** "Storage service temporarily unavailable. Retrying in {seconds}s..."
   - [ ] **Rate limited:** "Too many requests. Please wait {seconds} seconds."

6. **Error Handling - Server Errors**
   - [ ] **Server error 500:** "Server error occurred. Our team has been notified. Please try again later."
   - [ ] **Storage quota exceeded:** "Storage limit reached. Please contact administrator."
   - [ ] **Permission denied:** "Insufficient permissions to upload files."
   - [ ] **File already exists:** (Handled by Story 1.4, but show clear message)

7. **Retry Mechanism**
   - [ ] Automatic retry for transient network errors (up to 3 attempts)
   - [ ] Exponential backoff between retries (1s, 2s, 4s)
   - [ ] Manual "Retry Upload" button for failed uploads
   - [ ] Resume capability for interrupted uploads (if possible)
   - [ ] Clear indication when retrying ("Retry attempt 2 of 3...")

8. **User Actions on Errors**
   - [ ] "Retry Upload" button for failed uploads
   - [ ] "Cancel Upload" button during active upload
   - [ ] "Dismiss" button to clear error message after reading
   - [ ] "View Details" expands error message with technical details
   - [ ] "Report Problem" option for recurring issues

### Non-Functional Requirements

9. **Performance**
   - [ ] Progress updates don't impact upload speed
   - [ ] UI remains responsive during uploads
   - [ ] Progress calculation is accurate (±5%)
   - [ ] Error detection is immediate (<1 second)

10. **Usability**
    - [ ] Progress indicators are visually clear
    - [ ] Error messages are user-friendly, not technical
    - [ ] Color coding: green (success), yellow (warning), red (error)
    - [ ] Icons reinforce status (✓ success, ⚠️ warning, ✗ error)
    - [ ] Accessible to screen readers

## Technical Design

### Upload Progress Tracking

```typescript
// types/uploadProgress.ts

export type UploadState =
  | 'queued'
  | 'validating'
  | 'checking_collision'
  | 'uploading'
  | 'processing'
  | 'complete'
  | 'failed'
  | 'cancelled';

export interface UploadProgress {
  fileId: string;
  filename: string;
  state: UploadState;
  progress: number; // 0-100
  uploadedBytes: number;
  totalBytes: number;
  speed: number; // bytes per second
  estimatedTimeRemaining: number; // seconds
  startTime: number; // timestamp
  error?: UploadError;
  retryCount: number;
  maxRetries: number;
}

export interface UploadError {
  code: string;
  message: string; // User-friendly message
  details?: string; // Technical details
  retryable: boolean;
  timestamp: number;
}
```

### Progress Context

```typescript
// contexts/UploadProgressContext.tsx

interface UploadProgressContextValue {
  uploads: Map<string, UploadProgress>;
  startUpload: (fileId: string, filename: string, totalBytes: number) => void;
  updateProgress: (fileId: string, uploadedBytes: number) => void;
  updateState: (fileId: string, state: UploadState) => void;
  setError: (fileId: string, error: UploadError) => void;
  retryUpload: (fileId: string) => Promise<void>;
  cancelUpload: (fileId: string) => void;
  clearCompleted: () => void;
}

export function UploadProgressProvider({ children }) {
  const [uploads, setUploads] = useState<Map<string, UploadProgress>>(new Map());

  // Implementation...

  return (
    <UploadProgressContext.Provider value={contextValue}>
      {children}
    </UploadProgressContext.Provider>
  );
}
```

### Progress Component

```typescript
// components/upload/UploadProgressBar.tsx

interface UploadProgressBarProps {
  upload: UploadProgress;
  onRetry?: () => void;
  onCancel?: () => void;
}

export function UploadProgressBar({ upload, onRetry, onCancel }: UploadProgressBarProps) {
  const { state, progress, filename, uploadedBytes, totalBytes, speed, estimatedTimeRemaining, error } = upload;

  return (
    <div className="upload-progress-bar">
      <div className="upload-header">
        <FileIcon />
        <span className="filename">{filename}</span>
        <StateIndicator state={state} />
      </div>

      {/* Progress bar */}
      <div className="progress-bar-container">
        <div
          className="progress-bar-fill"
          style={{ width: `${progress}%` }}
        />
      </div>

      {/* Progress details */}
      <div className="progress-details">
        <span>{formatBytes(uploadedBytes)} / {formatBytes(totalBytes)}</span>
        <span>{progress}%</span>
        {speed > 0 && <span>{formatSpeed(speed)}</span>}
        {estimatedTimeRemaining > 0 && <span>{formatTime(estimatedTimeRemaining)} remaining</span>}
      </div>

      {/* Error display */}
      {error && (
        <ErrorMessage error={error} onRetry={onRetry} onDismiss={() => {}} />
      )}

      {/* Actions */}
      <div className="upload-actions">
        {state === 'uploading' && onCancel && (
          <button onClick={onCancel}>Cancel</button>
        )}
        {state === 'failed' && error?.retryable && onRetry && (
          <button onClick={onRetry}>Retry Upload</button>
        )}
      </div>
    </div>
  );
}
```

### Error Message Component

```typescript
// components/upload/ErrorMessage.tsx

interface ErrorMessageProps {
  error: UploadError;
  onRetry?: () => void;
  onDismiss: () => void;
}

export function ErrorMessage({ error, onRetry, onDismiss }: ErrorMessageProps) {
  const [showDetails, setShowDetails] = useState(false);

  return (
    <div className="error-message">
      <div className="error-header">
        <ErrorIcon />
        <span className="error-title">{error.message}</span>
      </div>

      {error.details && (
        <details>
          <summary onClick={() => setShowDetails(!showDetails)}>
            View technical details
          </summary>
          <pre className="error-details">{error.details}</pre>
        </details>
      )}

      <div className="error-actions">
        {error.retryable && onRetry && (
          <button onClick={onRetry} className="btn-retry">
            Retry Upload
          </button>
        )}
        <button onClick={onDismiss} className="btn-dismiss">
          Dismiss
        </button>
      </div>
    </div>
  );
}
```

### Upload with Progress Tracking

```typescript
// lib/uploadWithProgress.ts

export async function uploadFileWithProgress(
  file: File,
  onProgress: (progress: UploadProgress) => void
): Promise<UploadResult> {
  const fileId = generateId();
  const startTime = Date.now();

  try {
    // Update state: validating
    onProgress({
      fileId,
      filename: file.name,
      state: 'validating',
      progress: 0,
      uploadedBytes: 0,
      totalBytes: file.size,
      speed: 0,
      estimatedTimeRemaining: 0,
      startTime,
      retryCount: 0,
      maxRetries: 3,
    });

    // Validate file (Story 1.8)
    await validateFile(file);

    // Update state: checking collision
    onProgress({ ...previous, state: 'checking_collision', progress: 10 });

    // Check collision (Story 1.4)
    const collision = await checkCollision(file.name);
    if (collision) {
      // Handle collision...
    }

    // Update state: uploading
    onProgress({ ...previous, state: 'uploading', progress: 20 });

    // Upload with progress tracking
    const result = await uploadToAzure(file, (uploadedBytes) => {
      const progress = 20 + (uploadedBytes / file.size) * 70; // 20-90%
      const elapsed = (Date.now() - startTime) / 1000;
      const speed = uploadedBytes / elapsed;
      const remainingBytes = file.size - uploadedBytes;
      const estimatedTimeRemaining = speed > 0 ? remainingBytes / speed : 0;

      onProgress({
        ...previous,
        state: 'uploading',
        progress,
        uploadedBytes,
        speed,
        estimatedTimeRemaining,
      });
    });

    // Update state: processing
    onProgress({ ...previous, state: 'processing', progress: 95 });

    // Server-side processing
    await processUpload(result);

    // Update state: complete
    onProgress({
      ...previous,
      state: 'complete',
      progress: 100,
      uploadedBytes: file.size,
    });

    return result;

  } catch (error) {
    // Handle error with retry logic
    const uploadError = mapErrorToUploadError(error);
    onProgress({
      ...previous,
      state: 'failed',
      error: uploadError,
    });
    throw error;
  }
}
```

## UI Design

### Upload Progress Sidebar Section

```
┌─────────────────────────────────┐
│  Active Uploads (2)             │
├─────────────────────────────────┤
│  📄 chatlog1.json               │
│  🔄 Uploading...                │
│  ████████████░░░░░░░░  65%      │
│  3.2 MB / 5.0 MB • 1.2 MB/s     │
│  15 seconds remaining           │
├─────────────────────────────────┤
│  📄 chatlog2.json               │
│  ⏸️ Queued                      │
│  0% • Waiting...                │
├─────────────────────────────────┤
│  Recent (3)                     │
│  ✅ chatlog3.json  2:45 PM      │
│  ✅ chatlog4.json  2:43 PM      │
│  ❌ chatlog5.json  2:41 PM      │
│     [Retry] [Dismiss]           │
└─────────────────────────────────┘
```

### Error Message Examples

```
┌─────────────────────────────────────────────────────┐
│  ⚠️ Upload Failed                                   │
│                                                      │
│  File exceeds 10MB limit                            │
│  Current size: 15.2 MB                              │
│                                                      │
│  Please reduce the file size and try again.         │
│                                                      │
│  [Choose Different File]  [Dismiss]                 │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│  🔄 Upload Interrupted                              │
│                                                      │
│  Network connection lost                            │
│  Retrying upload... (Attempt 2 of 3)                │
│                                                      │
│  [Cancel] [View Details]                            │
└─────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────┐
│  ❌ Invalid JSON File                               │
│                                                      │
│  File is not valid JSON                             │
│  Error at line 42: Unexpected token }               │
│                                                      │
│  ▶ View technical details                           │
│                                                      │
│  [Choose Different File]  [Dismiss]                 │
└─────────────────────────────────────────────────────┘
```

## Dependencies

### Technical Dependencies
- Upload functionality from Story 1.2
- Azure Blob Storage from Story 1.5
- Validation logic from Story 1.8 (parallel work)

### Story Dependencies
- **Story 1.2** (File Upload Component) - REQUIRED
- **Story 1.5** (Azure Blob Storage) - REQUIRED
- Story 1.4 (Collision Detection) - Integration point
- Story 1.8 (Validation) - Integration point

## Testing Strategy

### Unit Tests
- [ ] Progress calculation accuracy
- [ ] State transitions are valid
- [ ] Error message mapping for all error types
- [ ] Speed and time estimation calculations
- [ ] Retry logic with exponential backoff

### Integration Tests
- [ ] Progress updates during actual upload
- [ ] Retry mechanism on simulated network failure
- [ ] Cancel operation stops upload
- [ ] Multiple concurrent uploads tracked correctly
- [ ] Error states trigger correctly for various failures

### End-to-End Tests
- [ ] Upload shows progress from 0-100%
- [ ] Success state appears after upload completes
- [ ] Failed upload shows retry button
- [ ] Retry button successfully re-uploads file
- [ ] Cancel button stops upload immediately
- [ ] Error messages display correctly for each error type

### Edge Cases
- [ ] Very fast upload (progress still visible)
- [ ] Very slow upload (accurate time estimation)
- [ ] Upload fails after 50% complete
- [ ] Network drops during upload
- [ ] User navigates away during upload
- [ ] Multiple simultaneous errors

## Definition of Done

- [ ] All acceptance criteria met
- [ ] Progress indicators implemented and accurate
- [ ] All upload states display correctly
- [ ] Error messages clear and user-friendly
- [ ] Retry mechanism working for transient errors
- [ ] Cancel functionality works correctly
- [ ] UI matches design specifications
- [ ] Unit tests written and passing (>80% coverage)
- [ ] Integration tests passing
- [ ] End-to-end tests passing
- [ ] Edge cases tested and handled
- [ ] Performance benchmarks met (UI remains responsive)
- [ ] Accessibility testing passed
- [ ] Code reviewed and approved
- [ ] Documentation updated (error code reference)
- [ ] Deployed to staging environment
- [ ] User acceptance testing completed
- [ ] No critical or high-priority bugs

## Success Metrics

### Technical Metrics
- Progress accuracy: **±5%** of actual upload
- Progress update frequency: **≥2 updates per second**
- Error detection time: **<1 second**
- Retry success rate: **>80%** for transient errors

### User Experience Metrics
- Users understand upload status: **>95%** (from user testing)
- Error messages are clear: **>90%** users can self-resolve
- User satisfaction with progress visibility: **4/5 or higher**

### Business Metrics
- Reduced support tickets for "lost uploads"
- Increased user confidence in upload process
- Faster issue resolution with clear error messages

## Notes

- **User Confidence:** Progress visibility dramatically improves user confidence
- **Error Recovery:** Good error messages reduce support burden
- **Accessibility:** Progress must be announced to screen readers
- **Mobile Responsive:** Progress UI should work on tablets
- **Performance:** Progress tracking shouldn't slow uploads

## Related Documentation

- [Epic 1](../prd/epic-1-file-upload-storage.md) - Parent Epic
- [Story 1.2](./1.2.file-upload-component.md) - File Upload Component (prerequisite)
- [Story 1.5](./1.5.azure-blob-storage.md) - Azure Blob Storage (prerequisite)
- [Story 1.8](./1.8.file-validation-security.md) - Validation (integration point)

---

*Story created: 2025-10-10*
*Last updated: 2025-10-10*
*Product Owner: Sarah*
