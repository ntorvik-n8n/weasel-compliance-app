# Story 2.4: Status Indicators and Processing States

## Story Overview

**Story ID:** 2.4
**Epic:** Epic 2 - Call Log Management System
**Priority:** P0 (Critical)
**Status:** Done
**Story Points:** 3
**Sprint:** Sprint 3 (Epic 2)

## User Story

**As a** compliance officer
**I want** to see clear visual indicators of each file's processing status
**So that** I know which files are ready for review, which are processing, and which have errors

## Background

Status indicators provide critical feedback about the current state of each uploaded file. As files move through the workflow (uploaded ‚Üí processing ‚Üí analyzed), users need real-time visual feedback. This story enhances the existing status badges and adds animated indicators for processing states.

## Current Implementation Status

**Already Implemented (Epic 1):**
- ‚úÖ Status badge component with colors
- ‚úÖ Basic statuses: success, error, uploading
- ‚úÖ Status column in file list
- ‚úÖ Status filter in search

**Needs Enhancement:**
- ‚è≥ Processing state (AI analysis in progress)
- ‚è≥ Analyzed state (AI complete, ready for review)
- ‚è≥ Queued state (waiting for AI processing)
- ‚è≥ Animated processing indicator
- ‚è≥ Status icons (beyond text badges)
- ‚è≥ Real-time status updates
- ‚è≥ Status tooltips with details
- ‚è≥ Progress percentage for processing

## Acceptance Criteria

### Functional Requirements

1. **Status States**
   - [x] **Uploaded** - File received, awaiting processing
   - [ ] **Queued** - In queue for AI analysis
   - [ ] **Processing** - AI analysis in progress
   - [ ] **Analyzed** - Analysis complete, ready for review
   - [x] **Error** - Processing failed
   - [ ] **Pending Review** - Analyzed but not yet reviewed by user

2. **Visual Design**
   - [ ] Each status has distinct color
   - [ ] Each status has icon
   - [ ] Processing state shows animation (spinner/pulse)
   - [ ] Color-blind friendly design
   - [ ] Icons supplement text (not replace)

3. **Status Badge Component**
   - [x] Pill-shaped badge
   - [ ] Icon + text combination
   - [ ] Appropriate size for list and detail views
   - [ ] Hover shows tooltip with details
   - [ ] Accessible (screen reader friendly)

4. **Color Coding**
   - üîµ **Uploaded** - Blue (neutral)
   - üü£ **Queued** - Purple (waiting)
   - üü° **Processing** - Yellow (in progress, animated)
   - üü¢ **Analyzed** - Green (success, ready)
   - üî¥ **Error** - Red (failed, needs attention)
   - ‚ö™ **Pending Review** - Gray (analyzed but unread)

5. **Icons**
   - üì§ **Uploaded** - Upload cloud icon
   - ‚è±Ô∏è **Queued** - Clock icon
   - ‚öôÔ∏è **Processing** - Spinning gear/cog icon
   - ‚úÖ **Analyzed** - Checkmark icon
   - ‚ö†Ô∏è **Error** - Warning/alert icon
   - üëÅÔ∏è **Pending Review** - Eye icon

6. **Real-time Updates**
   - [ ] Status updates automatically (no manual refresh)
   - [ ] Update mechanism: polling (every 5s) or WebSocket
   - [ ] Smooth transition between states (fade animation)
   - [ ] Update only changed files (efficient)

7. **Processing Details**
   - [ ] Processing badge shows progress percentage (optional)
   - [ ] Tooltip shows: "Processing: AI analysis in progress (45%)"
   - [ ] Estimated time remaining (if available)
   - [ ] Processing start timestamp

8. **Error Details**
   - [x] Error badge is red
   - [ ] Error icon (‚ö†Ô∏è or ‚úï)
   - [ ] Tooltip shows error message
   - [ ] Click for detailed error information
   - [ ] Retry action available

### Non-Functional Requirements

9. **Performance**
   - [ ] Status updates don't impact list performance
   - [ ] Polling uses exponential backoff
   - [ ] No excessive API calls (max 1 per 5 seconds)
   - [ ] Animations run at 60 FPS

10. **Accessibility**
    - [ ] Status conveyed through text, color, AND icon
    - [ ] Screen reader announces status
    - [ ] Color-blind friendly (not just color)
    - [ ] ARIA labels for status badges

## Technical Design

### Enhanced Status Type

```typescript
// types/fileManagement.ts - Update

export type FileStatus =
  | 'uploaded'      // Just uploaded, not queued yet
  | 'queued'        // In queue for AI processing
  | 'processing'    // AI analysis in progress
  | 'analyzed'      // Analysis complete
  | 'error'         // Processing failed
  | 'pending-review'; // Analyzed but user hasn't viewed

export interface FileStatusDetail {
  status: FileStatus;
  message?: string;
  progress?: number; // 0-100 for processing state
  startedAt?: string;
  completedAt?: string;
  estimatedTimeRemaining?: number; // seconds
  errorDetails?: {
    code: string;
    message: string;
    retryable: boolean;
  };
}
```

### Status Badge Component

```typescript
// components/common/StatusBadge.tsx - Enhanced

import { CheckCircleIcon, ClockIcon, CogIcon, ExclamationTriangleIcon, CloudArrowUpIcon, EyeIcon } from '@heroicons/react/24/solid';

interface StatusBadgeProps {
  status: FileStatus;
  details?: FileStatusDetail;
  size?: 'sm' | 'md' | 'lg';
  showIcon?: boolean;
  showProgress?: boolean;
}

const STATUS_CONFIG = {
  uploaded: {
    label: 'Uploaded',
    color: 'blue',
    icon: CloudArrowUpIcon,
    className: 'bg-blue-100 text-blue-800',
  },
  queued: {
    label: 'Queued',
    color: 'purple',
    icon: ClockIcon,
    className: 'bg-purple-100 text-purple-800',
  },
  processing: {
    label: 'Processing',
    color: 'yellow',
    icon: CogIcon,
    className: 'bg-yellow-100 text-yellow-800',
    animated: true,
  },
  analyzed: {
    label: 'Analyzed',
    color: 'green',
    icon: CheckCircleIcon,
    className: 'bg-green-100 text-green-800',
  },
  error: {
    label: 'Error',
    color: 'red',
    icon: ExclamationTriangleIcon,
    className: 'bg-red-100 text-red-800',
  },
  'pending-review': {
    label: 'Pending Review',
    color: 'gray',
    icon: EyeIcon,
    className: 'bg-gray-100 text-gray-800',
  },
};

export function StatusBadge({ status, details, size = 'md', showIcon = true, showProgress = true }: StatusBadgeProps) {
  const config = STATUS_CONFIG[status];
  const Icon = config.icon;

  return (
    <Tooltip content={getTooltipText(status, details)}>
      <span className={`inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-xs font-medium ${config.className}`}>
        {showIcon && (
          <Icon className={`h-4 w-4 ${config.animated ? 'animate-spin' : ''}`} />
        )}
        <span>{config.label}</span>
        {showProgress && status === 'processing' && details?.progress && (
          <span className="ml-1 text-xs">({details.progress}%)</span>
        )}
      </span>
    </Tooltip>
  );
}

function getTooltipText(status: FileStatus, details?: FileStatusDetail): string {
  switch (status) {
    case 'uploaded':
      return 'File uploaded successfully. Awaiting processing.';
    case 'queued':
      return `In queue for AI analysis. ${details?.estimatedTimeRemaining ? `Est. ${details.estimatedTimeRemaining}s` : ''}`;
    case 'processing':
      return `AI analysis in progress. ${details?.progress ?? 0}% complete.`;
    case 'analyzed':
      return `Analysis complete. Ready for review. Completed ${formatRelativeTime(details?.completedAt)}`;
    case 'error':
      return `Processing failed: ${details?.errorDetails?.message ?? 'Unknown error'}`;
    case 'pending-review':
      return 'Analysis complete but not yet reviewed.';
    default:
      return status;
  }
}
```

### Real-time Status Updates

```typescript
// hooks/useStatusPolling.ts - New hook

export function useStatusPolling(interval = 5000) {
  const { state, actions } = useFileManager();
  const [isPolling, setIsPolling] = useState(true);

  useEffect(() => {
    if (!isPolling) return;

    // Only poll if there are files in processing states
    const hasProcessingFiles = state.files.some(
      f => f.status === 'queued' || f.status === 'processing'
    );

    if (!hasProcessingFiles) {
      setIsPolling(false);
      return;
    }

    const pollTimer = setInterval(async () => {
      try {
        // Fetch updated status for processing files only
        const processingIds = state.files
          .filter(f => f.status === 'queued' || f.status === 'processing')
          .map(f => f.name);

        const updates = await fetchStatusUpdates(processingIds);
        actions.updateFileStatuses(updates);

        // Stop polling if no more processing files
        const stillProcessing = updates.some(
          u => u.status === 'queued' || u.status === 'processing'
        );
        if (!stillProcessing) {
          setIsPolling(false);
        }
      } catch (error) {
        console.error('Status polling error:', error);
      }
    }, interval);

    return () => clearInterval(pollTimer);
  }, [isPolling, state.files, interval]);

  return { isPolling, startPolling: () => setIsPolling(true) };
}
```

### API Endpoint for Status Updates

```typescript
// app/api/files/status/route.ts - New endpoint

export async function POST(request: NextRequest) {
  const { fileNames } = await request.json();

  const blobService = getBlobStorageService();
  const statusUpdates = [];

  for (const filename of fileNames) {
    const metadata = await blobService.getFileMetadata(filename, new Date());
    if (metadata) {
      statusUpdates.push({
        name: filename,
        status: metadata.status,
        progress: metadata.progress,
        errorDetails: metadata.errorDetails,
      });
    }
  }

  return NextResponse.json({ updates: statusUpdates });
}
```

## Dependencies

### External Dependencies
- @heroicons/react (for status icons)

### Internal Dependencies
- **Story 2.1:** Call Log List Display (REQUIRED)
- **Epic 3:** AI Analysis (provides processing/analyzed states)

### Blocking Dependencies
- None for UI components
- Epic 3 needed for real processing state transitions

## Testing Strategy

### Unit Tests
- [ ] StatusBadge renders correct color/icon per status
- [ ] Tooltip text generated correctly
- [ ] Status polling only polls when needed
- [ ] Status updates merge correctly

### Component Tests
- [ ] StatusBadge shows all status types correctly
- [ ] Processing badge shows spinner animation
- [ ] Hover shows detailed tooltip
- [ ] Icon + text accessibility

### Integration Tests
- [ ] Status polling updates file list
- [ ] Status transitions work (uploaded ‚Üí queued ‚Üí processing ‚Üí analyzed)
- [ ] Error states display correctly

## Implementation Steps

1. **Update Type Definitions** (30 min)
   - Expand FileStatus type
   - Add FileStatusDetail interface

2. **Enhance StatusBadge Component** (2 hours)
   - Add icons for all states
   - Add animations for processing
   - Add tooltips with details
   - Add progress percentage display

3. **Implement Status Polling** (3 hours)
   - Create useStatusPolling hook
   - Create API endpoint for status updates
   - Integrate with FileManagerContext
   - Add efficient update logic

4. **UI Integration** (1 hour)
   - Update EnhancedFileList to use new StatusBadge
   - Add status transitions
   - Test visual appearance

5. **Testing** (2 hours)
   - Unit tests
   - Component tests
   - Visual testing

**Total Estimate:** 1 day

## Definition of Done

- [ ] All acceptance criteria met
- [ ] All 6 status states implemented
- [ ] Status badges with icons and colors
- [ ] Processing state shows animation
- [ ] Real-time status updates working
- [ ] Tooltips provide helpful details
- [ ] Unit tests passing
- [ ] Component tests passing
- [ ] Accessibility requirements met
- [ ] Code reviewed and approved

## Success Metrics

- Users understand file status at a glance
- Processing states update in real-time (<5s latency)
- Status indicators rated clear by 95% of users
- Zero confusion about file readiness

## UI Reference

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Filename        ‚îÇ Status                               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ chatlog1.json   ‚îÇ üîµ Uploaded                         ‚îÇ
‚îÇ chatlog2.json   ‚îÇ üü£ Queued                           ‚îÇ
‚îÇ chatlog3.json   ‚îÇ üü° ‚öôÔ∏è Processing (45%)              ‚îÇ
‚îÇ chatlog4.json   ‚îÇ üü¢ ‚úÖ Analyzed                      ‚îÇ
‚îÇ chatlog5.json   ‚îÇ üî¥ ‚ö†Ô∏è Error                        ‚îÇ
‚îÇ chatlog6.json   ‚îÇ ‚ö™ üëÅÔ∏è Pending Review               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Hover Tooltip Examples:
- "AI analysis in progress. 45% complete."
- "Analysis complete. Ready for review. Completed 2 minutes ago"
- "Processing failed: Invalid JSON structure"
```

## Related Documentation

- [Epic 2](../prd/epic-2-call-log-management.md) - Parent Epic
- [Story 2.1](./2.1.call-log-list-display.md) - List Display (integration point)

---

*Story created: 2025-10-11*
*Last updated: 2025-10-11*
*Product Owner: Sarah*
*Architect: Winston*

---

## QA Results

**Gate Status:** ‚úÖ PASSED

**Reviewer:** Quinn (Test Architect)
**Date:** 2025-10-11

**Summary:**
The developer has successfully implemented all missing components for status indication. The new badge component is visually clear, and the real-time polling mechanism is now fully integrated and functional.

**Actionable Items:**
- [x] Implement the `StatusBadge` component with icons, animations, and tooltips.
- [x] Create the `useStatusPolling` hook for real-time updates.
- [x] Create the `/api/files/status` backend endpoint.
- [x] Integrate the new components to provide real-time status feedback in the UI.

**Full Report:** See [QA Gate Assessment](./../../qa/gates/2.4-status-indicators-processing-states.yml)
