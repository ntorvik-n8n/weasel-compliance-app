# Story 3.1: Anthropic API Integration Setup

## Story Overview

**Story ID:** 3.1
**Epic:** Epic 3 - AI Compliance Analysis Engine
**Priority:** P0 (Critical)
**Status:** Not Started
**Story Points:** 2
**Sprint:** Sprint 4 (Epic 3)

## User Story
**As a** developer
**I want** to set up a secure and reusable client for the Anthropic Claude API
**So that** other services can easily and safely make calls to the AI model.

## Technical Design
1.  **Create an API Client Service:**
    -   Create a new file: `lib/anthropic/client.ts`.
    -   Use the official `@anthropic-ai/sdk`.
    -   The client should be initialized in a singleton pattern to be reused across the application.
    -   It must be configured to fetch the API key from environment variables (`ANTHROPIC_API_KEY`).
2.  **Secure API Key Management:**
    -   Add `ANTHROPIC_API_KEY` to `.env.example` to instruct developers.
    -   Ensure the Next.js server environment correctly loads this variable. In a production environment, this will be populated from Azure Key Vault.
3.  **Create a Wrapper Function:**
    -   Implement a function `getComplianceAnalysis(transcript: Transcript): Promise<AnalysisResult>`.
    -   This function will encapsulate the logic for building the prompt, sending it to the API, and parsing the response.
    -   For now, the function can use a hardcoded sample transcript and the prompt structure from the Epic 3 PRD.
    -   It should expect a JSON response from Claude.
4.  **Type Definitions:**
    -   Create a new file `types/analysis.ts` to define the `AnalysisResult` and related types, matching the JSON structure in the Epic 3 PRD.

## Acceptance Criteria
- [x] The `@anthropic-ai/sdk` package is added as a dependency.
- [x] A new `lib/anthropic/client.ts` service is created.
- [x] The client successfully authenticates with the Anthropic API using an environment variable.
- [x] A test function can successfully call the Claude API and receive a valid, structured JSON response.
- [x] The API key is NOT hardcoded and is loaded from the environment.
- [x] Type definitions for the analysis results are created in `types/analysis.ts`.

---
*Architect: Winston*

---
## Dev Agent Record

**Completed by:** James (Full Stack Developer)
**Date:** 2025-10-11
**Enhanced:** 2025-10-12

**Summary of Work:**
- Installed the `@anthropic-ai/sdk`.
- Created `types/analysis.ts` to define the data structure for the AI's response.
- Added `ANTHROPIC_API_KEY` to the environment example file for secure key management.
- Implemented the Anthropic client service in `lib/anthropic/client.ts`. This includes a singleton client, a prompt construction function, and a primary `getComplianceAnalysis` function that calls the API and parses the JSON response.

**Enhancements (2025-10-12):**
- **Added comprehensive retry logic**: Automatic retry up to 3 attempts with exponential backoff (1s, 2s, 4s)
- **Implemented JSON repair strategies**: Handles malformed JSON responses from Claude API
  - Removes markdown code blocks
  - Extracts JSON from surrounding text
  - Fixes trailing commas
  - Fixes missing commas between properties
- **Enhanced validation**: Validates parsed JSON structure against expected schema
- **Improved error handling**: Detailed logging for debugging JSON parse failures
- **Configurable retries**: `maxRetries` parameter allows customization

**Technical Implementation:**
- `repairJSON()` function - Sanitizes and fixes common JSON formatting issues
- `validateAnalysisStructure()` - Type-safe validation using TypeScript type guards
- `parseWithRepair()` - Two-tier parsing (direct → repair)
- Exponential backoff prevents API rate limiting
- Preserves original errors for debugging

**Next Steps:**
- The next story will focus on creating the pipeline to trigger this service.

---

## QA Results

**Gate Status:** ✅ PASSED

**Reviewer:** Quinn (Test Architect)
**Date:** 2025-10-11

**Summary:**
The Anthropic API integration is successful. The client is well-structured, secure, and returns the expected data format. After some initial challenges with the testing approach, a successful validation was performed using an in-app test page, confirming all acceptance criteria are met.

**Actionable Items:**
- (None)

**Full Report:** See [QA Gate Assessment](./../../qa/gates/3.1-anthropic-api-integration.yml)
