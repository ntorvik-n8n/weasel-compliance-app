# Story 2.2: File Selection and Navigation

## Story Overview

**Story ID:** 2.2
**Epic:** Epic 2 - Call Log Management System
**Priority:** P0 (Critical)
**Status:** In Progress
**Story Points:** 5
**Sprint:** Sprint 3 (Epic 2)

## User Story

**As a** compliance officer
**I want** to click on a call log from the list and view its detailed contents
**So that** I can review the full transcript, metadata, and begin my compliance analysis

## Background

Users need to navigate from the uploaded file list to a detailed view of individual call logs. This story implements the selection mechanism, detail page, and navigation flow between list and detail views. This is a critical user journey that enables the core compliance review workflow.

## Acceptance Criteria

### Functional Requirements

1. **File Selection in List**
   - [ ] Clicking a file in the list selects it
   - [ ] Selected file is visually highlighted (background color change)
   - [ ] Only one file can be selected at a time
   - [ ] Selection state persists when navigating back from detail view
   - [ ] Keyboard navigation supported (arrow keys, Enter to open)

2. **Navigation to Detail View**
   - [ ] Clicking a selected file navigates to detail page
   - [ ] URL pattern: `/calls/[filename]` or `/calls/[id]`
   - [ ] Navigation preserves list state (filters, sort, pagination)
   - [ ] Browser back button returns to list with preserved state
   - [ ] Direct URL access to detail page works

3. **Detail Page Layout**
   - [ ] Page displays in main content area
   - [ ] Sidebar remains visible with file list
   - [ ] Current file is highlighted in sidebar
   - [ ] Header shows "Back to List" navigation
   - [ ] Breadcrumb navigation: Home > Call Logs > [filename]

4. **Metadata Display**
   - [ ] Call ID prominently displayed
   - [ ] Upload timestamp (formatted)
   - [ ] File size
   - [ ] Original filename
   - [ ] Agent information (id and name)
   - [ ] Client information (if present)
   - [ ] Call duration (formatted: MM:SS)
   - [ ] Call outcome
   - [ ] Processing status badge

5. **Transcript Display**
   - [ ] Transcript displayed in conversational format
   - [ ] Each turn shows speaker label (Agent/Client)
   - [ ] Each turn shows timestamp from call start
   - [ ] Speaker labels visually distinguished (colors or icons)
   - [ ] Scrollable transcript area
   - [ ] Clear, readable typography

6. **Navigation Controls**
   - [ ] "Back to List" button in header
   - [ ] Previous/Next file navigation buttons
   - [ ] Keyboard shortcuts (Esc to return, ← → for prev/next)
   - [ ] File selector dropdown in header (quick jump)

### Non-Functional Requirements

7. **Performance**
   - [ ] Detail page loads within 1 second
   - [ ] JSON parsing doesn't block UI
   - [ ] Smooth navigation transitions
   - [ ] No layout shift during load

8. **Responsiveness**
   - [ ] Works on desktop (1920x1080)
   - [ ] Works on laptop (1366x768)
   - [ ] Works on tablet (1024x768)
   - [ ] Responsive layout adjusts to viewport

9. **Accessibility**
   - [ ] Keyboard navigation fully functional
   - [ ] Focus indicators visible
   - [ ] Screen reader friendly labels
   - [ ] Semantic HTML structure

## Technical Design

### Route Structure

```
app/
├── page.tsx                    # Home with file list
├── calls/
│   └── [filename]/
│       └── page.tsx           # Call log detail page
```

### Data Flow

```
1. User clicks file in list
   ↓
2. FileManagerContext updates selectedFile state
   ↓
3. Router navigates to /calls/[filename]
   ↓
4. Detail page fetches file content from API
   ↓
5. JSON parsed and displayed
   ↓
6. User can navigate back or to next/prev file
```

### API Endpoints

**Get File Content:**
```typescript
GET /api/files/[filename]/content

Response:
{
  metadata: {
    name: string,
    size: number,
    uploadedAt: string,
    status: string
  },
  content: CallLogJSON // Full parsed JSON
}
```

### Component Structure

```typescript
// app/calls/[filename]/page.tsx
export default function CallLogDetailPage({ params }: { params: { filename: string } }) {
  // Fetch file content
  // Parse and display
}

// components/calls/CallLogHeader.tsx
// - Breadcrumbs
// - Back button
// - Next/Prev navigation

// components/calls/CallLogMetadata.tsx
// - All metadata fields
// - Status badge
// - Formatting

// components/calls/CallLogTranscript.tsx
// - Conversational display
// - Speaker labels
// - Timestamps
// - Scrollable area

// components/calls/TranscriptTurn.tsx
// - Individual turn
// - Speaker + text + time
```

### State Management

```typescript
// contexts/FileManagerContext.tsx - Add:
interface FileManagerState {
  // ... existing state
  selectedFile: string | null;
  selectedFileContent: CallLogJSON | null;
}

interface FileManagerActions {
  // ... existing actions
  selectFile: (filename: string) => void;
  clearSelection: () => void;
  loadFileContent: (filename: string) => Promise<void>;
}
```

### Type Definitions

```typescript
// types/callLog.ts
export interface CallLogJSON {
  callId: string;
  timestamp: string; // ISO 8601
  agent: {
    id: string;
    name: string;
  };
  client?: {
    id: string;
    name?: string;
  };
  duration: number; // seconds
  transcript: TranscriptTurn[];
  outcome?: string;
  metadata?: Record<string, any>;
}

export interface TranscriptTurn {
  timestamp: number; // seconds from call start
  speaker: 'agent' | 'client';
  text: string;
}
```

## Dependencies

### External Dependencies
- None (uses existing infrastructure)

### Internal Dependencies
- **Story 1.5:** Azure Blob Storage Integration (REQUIRED - for file fetching)
- **Story 2.1:** Call Log List Display (REQUIRED - for list navigation)

### Blocking Dependencies
- File list must exist to navigate from
- Azure storage must be functional to fetch file content

## Testing Strategy

### Unit Tests
- [ ] `selectFile()` updates state correctly
- [ ] `clearSelection()` resets state
- [ ] `loadFileContent()` fetches and parses JSON
- [ ] Metadata formatting functions work correctly
- [ ] Duration formatting (seconds to MM:SS)

### Component Tests
- [ ] CallLogHeader renders with correct filename
- [ ] CallLogMetadata displays all fields
- [ ] CallLogTranscript renders all turns
- [ ] TranscriptTurn distinguishes agent vs client
- [ ] Navigation buttons trigger correct actions

### Integration Tests
- [ ] Click file in list navigates to detail page
- [ ] Detail page fetches correct file content
- [ ] Back button returns to list
- [ ] Next/Prev navigation cycles through files
- [ ] Direct URL access loads correct file

### End-to-End Tests
- [ ] Complete user flow: upload → list → select → detail → back
- [ ] Keyboard navigation works throughout
- [ ] State preserved across navigation
- [ ] Error handling for missing files

## Definition of Done

- [ ] All acceptance criteria met (9 sections)
- [ ] Detail page implemented and functional
- [ ] File selection state management working
- [ ] Navigation between list and detail working
- [ ] Metadata displayed correctly
- [ ] Transcript displayed in readable format
- [ ] Unit tests written and passing (>80% coverage)
- [ ] Component tests passing
- [ ] Integration tests passing
- [ ] Keyboard navigation fully functional
- [ ] Responsive design working on all target devices
- [ ] Accessibility requirements met (WCAG 2.1 AA)
- [ ] Code reviewed and approved
- [ ] Documentation updated (component docs)
- [ ] No critical or high-priority bugs

## Success Metrics

### Technical Metrics
- Page load time: **<1 second**
- Navigation smoothness: **60 FPS**
- JSON parse time: **<200ms** for 1MB files

### User Experience Metrics
- Users can navigate to detail view within **2 clicks**
- Detail page rated **intuitive** by 90% of users
- Navigation flow rated **4/5** or higher

### Functional Metrics
- Zero navigation errors
- 100% state preservation on back navigation
- All keyboard shortcuts working

## UI Design Reference

### Detail Page Layout

```
┌─────────────────────────────────────────────────────────┐
│  [← Back to List]    chatlog1.json    [← Prev | Next →] │
├─────────────────────────────────────────────────────────┤
│                                                           │
│  Call Metadata Panel                                      │
│  ┌──────────────────────────────────────────────────┐  │
│  │ Call ID: CLG-2024-10-001                          │  │
│  │ Agent: John Smith (AGT-123)                       │  │
│  │ Duration: 12:34                                    │  │
│  │ Uploaded: Oct 10, 2025 2:43 PM                    │  │
│  │ Status: [Analyzed]                                 │  │
│  └──────────────────────────────────────────────────┘  │
│                                                           │
│  Transcript                                               │
│  ┌──────────────────────────────────────────────────┐  │
│  │ [Agent] (00:05)                                    │  │
│  │ Good morning, this is John from...                 │  │
│  │                                                     │  │
│  │ [Client] (00:15)                                   │  │
│  │ Yes, I'm calling about my account...              │  │
│  │                                                     │  │
│  │ [Agent] (00:25)                                    │  │
│  │ I understand. Let me pull up your information...  │  │
│  │                                                     │  │
│  │ (scrollable)                                       │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

## Architecture Notes

**Routing Strategy:**
- Use Next.js App Router dynamic routes: `app/calls/[filename]/page.tsx`
- Filename used as route param (URL-encoded)
- Consider using file ID instead of filename for cleaner URLs

**Data Fetching:**
- Server-side: Fetch from Azure Blob Storage in page component
- Client-side: Use SWR or React Query for caching
- Implement loading states during fetch

**State Management:**
- Selection state in FileManagerContext
- Navigation state in URL (Next.js router)
- File content cached in memory (SWR)

**Performance Optimization:**
- Lazy load transcript for large files
- Virtual scrolling if transcript > 500 turns
- Memoize parsed content
- Prefetch adjacent files on hover

## Related Documentation

- [Epic 2](../prd/epic-2-call-log-management.md) - Parent Epic
- [Story 2.1](./2.1.call-log-list-display.md) - Call Log List (prerequisite)
- [Call Log Schema](../../sample-files/standard-call.json) - JSON structure reference
- [UI Mockup](../../UI-calllog.png) - UI design reference

---

*Story created: 2025-10-11*
*Last updated: 2025-10-11*
*Product Owner: Sarah*
*Architect: Winston*

---

## QA Results

**Gate Status:** ✅ PASSED

**Reviewer:** Quinn (Test Architect)
**Date:** 2025-10-11

**Summary:**
The developer has successfully addressed all identified issues. The detail page now fetches and displays the full transcript, inter-file navigation is functional, and the list's state is preserved.

**Actionable Items:**
- [x] Implement data fetching for the full call log content on the detail page.
- [x] Build out the `CallLogTranscript` component to properly display the conversation.
- [x] Add "Previous" and "Next" navigation controls to the header.
- [x] Ensure list state (sorting, filtering) is preserved when navigating between the list and detail views.

**Full Report:** See [QA Gate Assessment](./../../qa/gates/2.2-file-selection-navigation.yml)